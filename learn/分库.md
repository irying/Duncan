## recom库的分库方案

### 背景

精准推荐所用数据库recom库，目前容量已达290多G。这个容量还不是大到一定要马上分库的地步，但在可观的未来，只会越来越大。

面对单一数据库或数据表因数据量过大而导致的性能瓶颈问题 。有两种思路去解决：**一种是数据拆分，另一种是换成分布式数据库。**分布式数据库集数据存储、管理以及分布式协调与计算为一体的数据库系统，目前已有PingCAP公司的TiDB，它有很多实践案例，我也曾调研实践过，结合实践和各种案例，发觉如果仅仅依靠短时间的实践和官方文档就把数据放到TiDB，未免有些草率。只有做足功课，多些场景测试和积累，才能接入TiDB。



### 数据拆分

**现在来到第1种思路：数据拆分。**

数据拆分分为垂直拆分和水平拆分。它们都有各自的适合场景，但大多数情况下都是结合着使用。

> 如果是因为表多而数据多，这时候适合使用垂直切分，即把关系紧密（比如同一模块）的表切分出来放在一个server上。如果表并不多，但每张表的数据非常多，这时候适合水平切分，即把表的数据按某种规则（比如按ID散列）切分到多个数据库(server)上。当然，现实中更多是这两种情况混杂在一起，这时候需要根据实际情况做出选择，也可能会综合使用垂直与水平切分，从而将原有数据库切分成类似矩阵一样可以无限扩充的数据库(server)阵列。 

回到recom库，按名称来说，总共23张表，其中有14张各自有100张分表，还有几张各自有10张分表。总体上看，每张表的数据量并不是很大，行记录数几千到几万不等，造成数据库容量大的原因主要是表多。**<u>所以这个阶段适合垂直拆分，让容量分开，等到单表的数据量超大，出现瓶颈时再把表迁移到其他节点。</u>**（由于部分表已经分表，到时无需分表操作，只剩迁移分表数据）



确定了垂直拆分之后，就要思考以什么维度进行拆分，才能达到数据均匀分布和关系紧密的表在一块的目标。

这个时候就要深入到业务中去展开调研。下面是精准推荐项目的维度划分。

​	维度1：算法，推荐算法大体上分为两类--基于用户做推荐和基于内容做推荐。

​	维度2：平台，现接入推荐算法主要有三大平台：PC、Android和iOS

​	维度3：类别，模板有三个类别，分别是wps、wpp和et。

这3个维度都能达到关系紧密的目标，这个不难理解，比如维度1，我想找某个算法的数据，我只要确定这个算法属于哪个类别，就去相应类别的数据库查数据；或者维度2，我想找Android的推荐数据，我去Android库就行。

但哪个维度分数据更均匀些呢，这时候我就根据之前统计好的表容量，每个维度模拟划分。对比发现只有维度2的比较理想。如果按维度1，发现基于用户的推荐算法总数据量达到210多G，根本就没有解决问题；如果按维度3，wpp的容量比et的容量大好几倍。

**最终，采用维度2**。

下面是两个阶段的拆分示意图，阶段1拆成4个库，不属于平台的数据放在一个基础库；阶段2，在阶段1的基础上再做迁移。比如pc 库的recom_ppt_00~99表总容量超大时，把这些表又单独迁出来。

![1533623871938](https://wx4.sinaimg.cn/mw690/e5b38bb8gy1fu14oqepvkj20ed08rdg0.jpg)

​									       **阶段1：垂直拆分**



![1533631502481](https://wx3.sinaimg.cn/mw690/e5b38bb8gy1fu18d9o1yej20g70b5q3b.jpg)

​								        **阶段2：已水平拆分的表迁移**



### 垂直拆分后的数据详情

#### 1.基础库，跟平台无关（12G）

|      |                        |                        | 容量                  |
| ---- | ---------------------- | ---------------------- | --------------------- |
| 1    | mb_meta                | 模板元数据             | 227.70M               |
| 2    | recom_keyword_hdid_0~9 | hdid用户推荐表（废弃） | 24.65GB               |
| 3    | recom_keyword_hdid_a~f | hdid用户推荐表（废弃） |                       |
| 4    | recom_keyword_user_0~9 | （废弃）               | 14.56GB               |
| 5    | user_history_00~99     | 用户操作记录表         | 12.00GB               |
| 总计 |                        |                        | 51.21G+（废弃39.21G） |

#### 2.按平台分库(android43.13G+, iOS 62.96G+ , pc 114.1G+  )

| android |                                |                       | 容量     |
| ------- | ------------------------------ | --------------------- | -------- |
| 1       | recom_android_et_00~99         | 安卓et用户推荐表      | 14.77GB  |
| 2       | recom_android_item             | 安卓物品推荐表        | 164.30MB |
| 3       | recom_android_meihua_et_00~99  | 安卓美化et用户推荐表  | 1.56MB   |
| 4       | recom_android_meihua_item      | 安卓美化物品推荐表    | 3.14MB   |
| 5       | recom_android_meihua_wpp_00~99 | 安卓美化wpp用户推荐表 | 1.38GB   |
| 6       | recom_android_meihua_wps_00~99 | 安卓美化wps用户推荐表 | 1.56MB   |
| 7       | recom_android_wpp_00~99        | 安卓wpp用户推荐表     | 23.06GB  |
| 8       | recom_android_wps_00~99        | 安卓wps用户推荐表     | 3.93GB   |
| 总计    |                                |                       | 43.13G+  |

| ios  |                            |                       | 容量    |
| ---- | -------------------------- | --------------------- | ------- |
| 1    | recom_ios_et_00~99         | 苹果et用户推荐表      | 21.67GB |
| 2    | recom_ios_item             | 苹果物品推荐表        | 72.55MB |
| 3    | recom_ios_meihua_item      | 苹果美化物品推荐表    | 6.14MB  |
| 4    | recom_ios_meihua_wpp_00~99 | 苹果美化wpp用户推荐表 | 2.67GB  |
| 5    | recom_ios_wps_00~99        | 苹果wps用户推荐表     | 25.80GB |
| 6    | recom_ios_wpp_00~99        | 苹果wpp用户推荐表     | 12.82GB |
|      | recom_ios_meihua_et_00~99  | 暂无                  |         |
|      | recom_ios_meihua_wps_00~99 | 暂无                  |         |
| 总计 |                            |                       | 62.96G+ |

| pc   |                   |                    | 容量     |
| ---- | ----------------- | ------------------ | -------- |
| 1    | recom_item        | pc物品推荐表       | 632.19MB |
| 2    | recom_ppt_00~99   | recom_pc_wpp_00~99 | 47.93GB  |
| 3    | recom_word_00~99  | recom_pc_wps_00~99 | 44.74GB  |
| 4    | recom_excel_00~99 | recom_pc_et_00~99  | 21.43GB  |
| 总计 |                   |                    | 114.1G+  |

### 流程安排

分库有两个场景，停服和不停服

不停服：

​	1.改代码

​	2.创建分库，并在分库中创建分表

​	3.指定数据到特定的库和表

​        4.上新代码

​        5.检查

停服：

​	1.改代码

​	2.按规则从原库全量导入到新库

​        3.检查代码



一个分库流程的是否安排妥当在于是否能解决分库前后遇到的所有问题。

##### 分库前

​	1.有没有用到事务

​	有，改成分布式事务。

​	2.有没有跨库join查询

​	有，先取一个库的结果，再拿结果去取另一个库的结果

​	3.跨节点的count,order by,group by以及聚合函数问题

​	同2

​        4.自增ID问题

​	由于我们只是垂直拆分，暂时不需要考虑不同节点的自增ID问题

##### 分库中

​	1.能不能停服不接受新数据

​	  不能，记录同步过程中产生的新数据，同步完成后再根据记录日志补充数据

​        2.同步过程中断怎么办

​          取决于同步工具

##### 分库后

​	1.检查所有项目的sql执行情况，受影响的库

 





